# 进阶

+ 项目中对事务的使用，项目中哪里用到了索引、联合索引存储什么、联合索引和聚簇索引用同一颗B+树吗
+ MySql主从复制，MySql读写分离
+ 建立了哪些索引，联合索引哪个放在了前面



# 涉及的查询

## 注册

查看用户是否存在

```sql
select count(*)
    from boying_user
    where username = #{username} or phone = #{telephone}
```

## 根据用户名查询

```sql
select
<include refid="Base_Column_List" />
from boying_user
where username = #{username}
```

## 根据手机号查询

```sql
select
<include refid="Base_Column_List" />
from boying_user
where phone = #{telephone}
```

## 菜单查询

```sql
select
    <include refid="Base_Column_List"/>
    from boying_category
    where admin_delete = 0
    order by weight desc
```

## 演出查询

```sql
select
    <include refid="Base_Column_List"/>
    from boying_show
    <where>
        <if test="categoryId != null and categoryId != 0">
            category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            and name like concat('%',#{keyword,jdbcType=VARCHAR},'%')
        </if>
        <if test="city != null and city != '' and city != '全国'">
            and city = #{city}
        </if>
        <if test="startDay != null and endDay != null">
            and start_time
            between #{startDay} and #{endDay}
        </if>
    </where>
    <if test="sort == null">
        order by weight desc
    </if>
    <if test="sort == 0">
        order by weight desc
    </if>
    <if test="sort == 1">
        order by START_TIME asc
    </if>
    <if test="sort == 2">
        order by START_TIME desc
    </if>
    <if test="sort == 3">
        order by MIN_PRICE asc
    </if>
    <if test="sort == 4">
        order by MIN_PRICE desc
    </if>
    <if test="sort == 5">
        order by MAX_PRICE asc
    </if>
    <if test="sort == 6">
        order by MAX_PRICE desc
    </if>
</select>
```

## 演出座次查询

```sql
select
<include refid="Base_Column_List"/>
from boying_seat
where show_id = #{showId}
```

## 查看该用户对该演出是否下单过

```sql
select count(*)
from boying_order
where user_id = #{userId}
  and show_id = #{showId}
  and status != 3
```

## 订单条件查询

```sql
select
<include refid="Base_Column_List"/>
from boying_order
where user_id = #{userId} and user_delete != 1
<if test="status != null and status != 0">
    and status = #{status}
</if>
<if test="name != null and name != ''">
    and show_id in
    (select id from boying_show where name like concat('%',#{name},'%')
</if>
```

## 查看并减库存

```sql
update boying_stock
set stock = stock - #{ticketCount}
where id = #{seatId}
  and stock >= #{ticketCount}
```

## 增加库存

```sql
update boying_stock
set stock = stock + #{ticketCount}
where id = #{seatId}
```

## 根据演出座次获取活动信息

```sql
select
<include refid="Base_Column_List"/>
from boying_promo
where seat_id = #{seatId,jdbcType=INTEGER}
```

# expain与索引优化

## 用户信息

优化前：

![image-20210216153841728](https://tongji2021.oss-cn-shanghai.aliyuncs.com/img/image-20210216153841728.png)

虽然username、phone都是唯一的，但是只添加普通索引，不添加唯一索引

![image-20210216154531210](https://tongji2021.oss-cn-shanghai.aliyuncs.com/img/image-20210216154531210.png)

```sql
explain select count(*)
from boying_user
where username = 'tongji4m3' or phone = '15316162191';

explain select * from boying_user where username = 'tongji4m3';

explain select * from boying_user where phone = '15316162191';

ALTER  TABLE  `boying_user`  ADD  INDEX index_username (`username`);
ALTER  TABLE  `boying_user`  ADD  INDEX index_phone (`phone`);

drop index index_name on boying_user;
show indexes from boying_user;
```

其实上述语句等价于

```sql
select count(*) from boying_user where username = 'tongji4m3'
union
select count(*) from boying_user where phone = '15316162191';
```

## 订单信息

建立了复合索引(user_id,show_id)，这样在查看该用户对该演出是否下单过时可以用到两个索引，在单独查询用户的所有订单也可以用到索引（索引前缀）

```sql
explain select count(*) from boying_order where user_id = 1 and show_id = 1;

explain select * from boying_order where user_id = 1;

ALTER  TABLE  `boying_order`  ADD  INDEX index_order (user_id,show_id);

show indexes from boying_order;
```

# 