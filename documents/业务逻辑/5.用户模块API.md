---
title: 用户模块后端设计逻辑
date: 2021-01-13
author: tongji4m3
top: false
cover: false
coverImg: /images/1.jpg
toc: true
mathjax: false
summary: 用户模块后端设计逻辑，把每个模块请求、返回对象详细描述
categories: 博影项目笔记
tags:

  - 项目
  - API
  - token







---



# 用户模块

```
/user
```

## 注册

| API      | /register                               |
| -------- | --------------------------------------- |
| 参数     | username、password、telephone、authCode |
| 可选参数 | icon                                    |
| 返回值   |                                         |
| 说明     |                                         |

+ 校验验证码
+ 检查用户名或手机号是否存在
+ 对密码加密存储
+ 若没有头像，则设置默认头像
+ 删除该验证码，防止重复使用


![image-20210109195030427](https://tongji4m3.oss-cn-beijing.aliyuncs.com/image-20210109195030427.png)

## 账号密码登录

| API    | /usernameLogin     |
| ------ | ------------------ |
| 参数   | username、password |
| 返回值 | token              |
| 说明   |                    |

+ 首先从缓存中通过`username`获取用户信息

+ 获取不到则通过username查询数据库（数据库也没有则报错给前端）

+ 检验账号是否被禁用

+ 并且将查到的存入redis中（用户名，用户信息）（手机号，用户信息）

+ 将用户输入的密码加密后与数据库查到的user密码对比（密码错误则报错给前端）

+ 在服务器内存中存储了该用户信息，返回`token`给前端

	

	

	

## 手机号密码登录

| API    | /telephoneLogin     |
| ------ | ------------------- |
| 参数   | telephone、password |
| 返回值 | token               |
| 说明   |                     |

+ 首先从redis中通过`telephone`获取用户信息
+ 获取不到则查询数据库（数据库也没有则报错给前端）
+ 检验账号是否被禁用
+ 将查到的存入redis中
+ 将用户输入的密码与数据库查到的`user`对比（密码错误则报错给前端）
+ 在服务器内存中存储了该用户信息，返回`token`给前端

## 手机号验证码登录

| API    | /authCodeLogin      |
| ------ | ------------------- |
| 参数   | telephone、authCode |
| 返回值 | token               |
| 说明   |                     |

+ 首先校验验证码
+ 在redis中通过`telephone`获取用户信息
+ 获取不到则查询数据库，并且将查到的存入redis中
+ 检验账号是否被禁用
+ 
+ 在服务器内存中存储了该用户信息，返回`token`给前端

## 修改密码

| API    |      |
| ------ | ---- |
| 参数   |      |
| 返回值 |      |
| 说明   |      |

+ 查询该手机号是否存在
+ 校验验证码
+ 给密码进行加密
+ 更新成功时删除无效缓存(删除两条，分别是{username:user}，{telephone:user})（删除该验证码，防止重复使用）

## 更新个人信息

| API    |      |
| ------ | ---- |
| 参数   |      |
| 返回值 |      |
| 说明   |      |

+ 参数都是可选的参数
+ 更新成功时删除无效缓存

## 获取个人信息

| API    |      |
| ------ | ---- |
| 参数   |      |
| 返回值 |      |
| 说明   |      |

没登录时会报错，否则返回当前登录用户的信息

将核心领域模型用户对象转化为可供UI使用的viewObject对象

## 获取验证码

| API    |      |
| ------ | ---- |
| 参数   |      |
| 返回值 |      |
| 说明   |      |

+ 查询生成6位随机数
+ 用`redis`存储手机号，验证码，90秒过期
+ 用阿里云服务向手机号发送验证码

## 刷新token

| API    |      |
| ------ | ---- |
| 参数   |      |
| 返回值 |      |
| 说明   |      |

+ 如果`token`过期或者在30分钟之内刚刷新过，则不进行操作
+ 否则通过原先的`token`的用户信息和当前的时间新生成一个`token`

# 菜单模块

```
/category
```

## 查看菜单

| API    | /categories                                  |
| ------ | -------------------------------------------- |
| 参数   |                                              |
| 返回值 | CommonResult<List<BoyingCategory>>           |
| 说明   | 只能查看未被管理员删除的菜单，按照weight降序 |
|        | 如果菜单列表为空，则返回404                  |

## 查看菜单详情

| API    | /details/{id}                |
| ------ | ---------------------------- |
| 参数   | id                           |
| 返回值 | CommonResult<BoyingCategory> |
| 说明   | 只能查看未被管理员删除的菜单 |

# 演出模块

```
/show
```

## 演出的综合搜索筛选

| API      | /search                                      |
| -------- | -------------------------------------------- |
| 参数     |                                              |
| 可选参数 | keyword、city、categoryId、pageNum、pageSize |
| 返回值   | CommonResult<CommonPage<BoyingShow>>         |
| 说明     | 也返回最低价，最高价                         |


* 可根据以下的几种综合搜索演出:
* 关键词，城市，菜单
* 按weight降序
* 分页:每页条数，分页数

## 获取某个演出详情

| API    | /detail/{id}                                           |
| ------ | ------------------------------------------------------ |
| 参数   | id                                                     |
| 返回值 | CommonResult<BoyingShow>                               |
| 说明   | 通过show_id获取该演出信息,用于在进入特定的演出详情页面 |
|        | 也返回最低价，最高价                                   |

# 演出座次模块

## 获取某演唱会的所有座次

| API    | /detail/{showId}                          |
| ------ | ----------------------------------------- |
| 参数   | showId                                    |
| 返回值 | CommonResult<List<BoyingSeatVO>>          |
| 说明   | 根据show_id获取该演出的所有座次，不用分页 |

+ 根据show_id获取该演出的所有座次
+ 从库存表中查出剩余的库存
+ 从秒杀活动表中查询活动，并已封装成了领域模型（根据活动开始和结束的时间封装了秒杀活动状态0表示没有活动 1表示还未开始，2表示进行中，3表示已结束）
+ 将上述查到的组合封装成BoyingSeatModel
+ 在controller层又封装成BoyingSeatVO对象（如果有活动则放入活动状态、活动Id，活动开始时间、活动价；没有活动则将活动状态置为0），并返回给前端

## 获取某座次详情

| API    | /detail/{seatId}           |
| ------ | -------------------------- |
| 参数   | seatId                     |
| 返回值 | CommonResult<BoyingSeatVO> |
| 说明   | 聚合了活动相关信息，和上述 |

# 订单模块

订单状态：待观看，已完成，已取消(1，2，3)

票模块不提供额外接口，只提供service

## 用户下单

| API    | /add                                          |
| ------ | --------------------------------------------- |
| 参数   | showId、seatId、ticketCount、payment、promoId |
| 返回值 |                                               |
| 说明   |                                               |

一个用户对一个演出只能下单1次，但是可以买[1，3]张票（只能买相同座次）

+ 验证传入参数（演出座次要大于等于1，小于等于3）
+ 验证传入的演出座次是否属于传入的演出
+ 查看该登录用户对于该演出的订单是否已经存在（已退票的不算）
+ 查看是否传入活动信息
    + 校验传入的活动是否对应于这个座次
    + 校验活动是否正在进行中
    + 如果都存在，则设置为活动价
+ 查看并减库存
+ 生成订单，下单人为当前用户、show_id、promoId（为0代表不是活动价）、待观看状态（1）、时间、user_delete=0、admin_delete=0、订单总价，订单票总数、生成对应的二维码与信息

## 查看所有订单

| API      | /list                                   |
| -------- | --------------------------------------- |
| 可选参数 | name、userId、status、pageNum、pageSize |
| 返回值   | CommonResult<CommonPage<BoyingOrder>>   |
| 说明     |                                         |

- 订单信息，订单状态，禁用状态
- 用户删除的订单不显示，管理员删除的订单会显示状态，便于申述
- 只用为观看订单展示管理员删除状态
- 未观看订单不允许删除

![img](https://tongji4m3.oss-cn-beijing.aliyuncs.com/C38C9D225E745E10DB35A23A517BD6F5.jpg)

+ 先查询当前用户，再根据用户Id查询订单表
+ 可分类查询：待观看，已完成，已取消
+ 支持订单名称（即演唱会名）模糊搜索
+ 查看未被用户删除的订单
+ 管理员删除的订单也返回，不过查看订单详情时则不允许
+ 支持分页查询

## 查看订单详情

| API    | details/{id} |
| ------ | ------------ |
| 参数   | id           |
| 返回值 |              |
| 说明   |              |

+ 传入订单Id，获取当前用户，校验是否是该用户的订单、获取没被用户删除的订单
+ 如果订单被管理员删除，则提示并返回
+ 查询票的详情，返回订单和票的信息

## 删除订单

| API    | /delete/{id} |
| ------ | ------------ |
| 参数   | id           |
| 返回值 |              |
| 说明   |              |

+ 仅仅是用户层面的删除订单，即对用户隐藏
+ 传入订单Id，获取当前用户
+ 校验是否是该用户的订单（订单Id，当前用户Id，user_delete为false的）
+ 如果订单为待观看状态，不能删除
+ 如果订单已经被管理员删除，则不能删除
+ 将该Id的user_delete设为true

## 取消订单

| API    | /cancel/{id} |
| ------ | ------------ |
| 参数   | id           |
| 返回值 |              |
| 说明   |              |

+ 获取当前用户
+ 获取订单（订单Id，当前用户Id，user_delete为false的）
+ 只能取消待观看订单
+ 增加订单对应座次的库存
+ 删除订单对应的票
+ 设置订单状态为已取消（3）

# 一些简化

## 订单流程简化

+ 没有购物车，订单也没有待付款的操作，用户选好票后直接付款就生成了订单。
+ 没有线下寄件的操作，用户订单生成后直接也只能可以查看电子票。
+ 订单只有待观看，已完成，已退票状态。

	

